# 诊断网站加载超时问题

## 问题
访问 `https://www.rancho.website/` 时出现超时。

## 快速诊断步骤

### 1. 检查服务器是否运行

```bash
# SSH连接到服务器
gcloud compute ssh --zone "europe-west2-a" "instance-20251230-121152" --project "project-c9bc7311-141d-4b19-8bb"

# 检查Nginx状态
sudo systemctl status nginx

# 检查后端服务状态
sudo systemctl status ppt-enhancer

# 如果服务未运行，启动它们
sudo systemctl start nginx
sudo systemctl start ppt-enhancer
```

### 2. 检查DNS解析

**在本地电脑上运行：**
```bash
# Windows (PowerShell)
nslookup www.rancho.website

# Mac/Linux
dig www.rancho.website +short
# 或
nslookup www.rancho.website
```

**应该返回：** `34.142.75.113`（新服务器IP）或 `34.168.121.40`（旧服务器IP）

**如果DNS解析错误：**
- 登录你的域名注册商/DNS服务商
- 检查 `www.rancho.website` 的A记录是否指向正确的IP
- 等待DNS传播（可能需要几分钟到几小时）

### 3. 检查防火墙规则

**在服务器上运行：**
```bash
# 检查防火墙状态
sudo ufw status

# 如果防火墙未启用或未配置，允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp  # SSH
sudo ufw enable
```

**检查GCP防火墙规则：**
```bash
# 在本地电脑上运行（需要gcloud CLI）
gcloud compute firewall-rules list --filter="name~'http' OR name~'https'"

# 如果缺少规则，创建它们
gcloud compute firewall-rules create allow-http --allow tcp:80 --source-ranges 0.0.0.0/0
gcloud compute firewall-rules create allow-https --allow tcp:443 --source-ranges 0.0.0.0/0
```

### 4. 检查Nginx配置

**在服务器上运行：**
```bash
# 检查Nginx配置语法
sudo nginx -t

# 查看Nginx错误日志
sudo tail -50 /var/log/nginx/error.log

# 查看Nginx访问日志
sudo tail -50 /var/log/nginx/access.log

# 检查Nginx是否在监听端口
sudo netstat -tlnp | grep nginx
# 或
sudo ss -tlnp | grep nginx
```

**应该看到：**
- `0.0.0.0:80` (HTTP)
- `0.0.0.0:443` (HTTPS，如果已配置SSL)

### 5. 检查SSL证书

**在服务器上运行：**
```bash
# 检查SSL证书是否存在
sudo ls -la /etc/letsencrypt/live/www.rancho.website/

# 检查证书有效期
sudo certbot certificates

# 如果证书不存在或过期，重新申请
sudo certbot --nginx -d www.rancho.website
```

### 6. 测试本地连接

**在服务器上运行：**
```bash
# 测试HTTP（端口80）
curl -I http://127.0.0.1/
curl -I http://localhost/

# 测试HTTPS（端口443，如果已配置）
curl -I https://127.0.0.1/ -k

# 测试API
curl http://127.0.0.1:5000/api/health
```

### 7. 测试公网连接

**在服务器上运行：**
```bash
# 测试HTTP
curl -I http://34.142.75.113/

# 测试HTTPS（如果已配置）
curl -I https://34.142.75.113/ -k
```

**在本地电脑上运行：**
```bash
# 测试HTTP
curl -I http://www.rancho.website/

# 测试HTTPS
curl -I https://www.rancho.website/ -k

# 测试IP地址
curl -I http://34.142.75.113/
```

### 8. 检查后端服务

**在服务器上运行：**
```bash
# 检查Gunicorn是否运行
ps aux | grep gunicorn

# 检查端口5000是否被监听
sudo netstat -tlnp | grep 5000
# 或
sudo ss -tlnp | grep 5000

# 查看服务日志
sudo journalctl -u ppt-enhancer -n 50 --no-pager
```

## 常见问题和解决方案

### 问题1：DNS未解析到正确IP

**症状：** `nslookup www.rancho.website` 返回错误的IP或超时

**解决：**
1. 登录域名注册商/DNS服务商
2. 检查A记录：
   - 主机名：`www`
   - 类型：`A`
   - 值：`34.142.75.113`（新服务器）或 `34.168.121.40`（旧服务器）
   - TTL：3600
3. 等待DNS传播（5分钟到48小时）

### 问题2：防火墙阻止连接

**症状：** 服务器上可以访问，但公网无法访问

**解决：**
```bash
# 在服务器上
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw reload

# 在GCP控制台
# 1. 进入 VPC网络 > 防火墙规则
# 2. 创建规则：
#    - 名称：allow-http
#    - 目标：所有实例
#    - 来源IP：0.0.0.0/0
#    - 协议和端口：tcp:80
# 3. 创建规则：
#    - 名称：allow-https
#    - 目标：所有实例
#    - 来源IP：0.0.0.0/0
#    - 协议和端口：tcp:443
```

### 问题3：Nginx未运行

**症状：** `sudo systemctl status nginx` 显示 `inactive`

**解决：**
```bash
sudo systemctl start nginx
sudo systemctl enable nginx
sudo systemctl status nginx
```

### 问题4：后端服务未运行

**症状：** `sudo systemctl status ppt-enhancer` 显示 `inactive` 或 `failed`

**解决：**
```bash
# 查看详细错误
sudo journalctl -u ppt-enhancer -n 100 --no-pager

# 检查配置文件
sudo nano /etc/systemd/system/ppt-enhancer.service

# 重启服务
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer
sudo systemctl status ppt-enhancer
```

### 问题5：SSL证书问题

**症状：** HTTPS无法访问，浏览器显示"不安全连接"

**解决：**
```bash
# 重新申请证书
sudo certbot --nginx -d www.rancho.website

# 如果失败，使用standalone模式
sudo systemctl stop nginx
sudo certbot certonly --standalone -d www.rancho.website
sudo systemctl start nginx

# 手动配置Nginx（参考"手动配置HTTPS.md"）
```

### 问题6：Nginx配置错误

**症状：** `sudo nginx -t` 显示错误

**解决：**
```bash
# 查看错误详情
sudo nginx -t

# 检查配置文件
sudo nano /etc/nginx/sites-available/ppt-enhancer

# 确保配置正确（参考"新服务器部署指南.md"）
# 修复后测试
sudo nginx -t
sudo systemctl reload nginx
```

### 问题7：端口被占用

**症状：** Nginx无法启动，提示端口已被占用

**解决：**
```bash
# 检查端口占用
sudo netstat -tlnp | grep :80
sudo netstat -tlnp | grep :443

# 如果被其他程序占用，停止它或修改Nginx配置使用其他端口
```

## 完整诊断脚本

**在服务器上运行以下脚本，自动检查所有问题：**

```bash
#!/bin/bash
echo "=== 诊断网站超时问题 ==="
echo ""

echo "1. 检查Nginx状态..."
sudo systemctl status nginx --no-pager -l | head -5
echo ""

echo "2. 检查后端服务状态..."
sudo systemctl status ppt-enhancer --no-pager -l | head -5
echo ""

echo "3. 检查端口监听..."
echo "HTTP (80):"
sudo netstat -tlnp | grep :80 || echo "  未监听"
echo "HTTPS (443):"
sudo netstat -tlnp | grep :443 || echo "  未监听"
echo "API (5000):"
sudo netstat -tlnp | grep :5000 || echo "  未监听"
echo ""

echo "4. 检查Nginx配置..."
sudo nginx -t
echo ""

echo "5. 检查SSL证书..."
if [ -d "/etc/letsencrypt/live/www.rancho.website" ]; then
    echo "  证书存在"
    sudo certbot certificates | grep www.rancho.website
else
    echo "  证书不存在"
fi
echo ""

echo "6. 测试本地连接..."
curl -I http://127.0.0.1/ 2>&1 | head -1
echo ""

echo "7. 检查防火墙..."
sudo ufw status | head -5
echo ""

echo "8. 查看最近的Nginx错误..."
sudo tail -10 /var/log/nginx/error.log
echo ""

echo "=== 诊断完成 ==="
```

**保存为 `diagnose.sh` 并运行：**
```bash
chmod +x diagnose.sh
./diagnose.sh
```

## 快速修复命令

如果确定是某个问题，可以快速修复：

```bash
# 重启所有服务
sudo systemctl restart nginx
sudo systemctl restart ppt-enhancer

# 检查状态
sudo systemctl status nginx
sudo systemctl status ppt-enhancer

# 测试连接
curl http://127.0.0.1/api/health
```

## 联系支持

如果以上步骤都无法解决问题，请提供以下信息：

1. `sudo systemctl status nginx` 的输出
2. `sudo systemctl status ppt-enhancer` 的输出
3. `sudo nginx -t` 的输出
4. `sudo tail -50 /var/log/nginx/error.log` 的输出
5. `nslookup www.rancho.website` 的输出（在本地电脑上）
6. `curl -I https://www.rancho.website/` 的输出（在本地电脑上）

