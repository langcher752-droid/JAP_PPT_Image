# 调试环境变量问题

## 问题
systemd服务无法读取环境变量，导致API配置显示为false。

## 调试步骤

### 1. 检查systemd服务文件中的环境变量

```bash
sudo cat /etc/systemd/system/ppt-enhancer.service
```

确保有类似这样的行：
```ini
Environment="GOOGLE_API_KEY=你的密钥"
Environment="GOOGLE_CSE_ID=你的CSE_ID"
Environment="GOOGLE_AI_API_KEY=你的Gemini密钥"
Environment="SPARK_API_KEY=你的Spark密钥"
```

### 2. 检查服务实际运行时的环境变量

```bash
# 查看服务进程的环境变量
sudo systemctl show ppt-enhancer | grep Environment
```

或者：
```bash
# 查看进程的环境变量
sudo cat /proc/$(pgrep -f "gunicorn.*web_app")/environ | tr '\0' '\n' | grep -E "GOOGLE|SPARK"
```

### 3. 测试代码是否能读取环境变量

创建一个测试脚本：
```bash
cd /srv/jp-ppt
cat > test_env.py << 'EOF'
import os
print("GOOGLE_API_KEY:", os.getenv('GOOGLE_API_KEY', 'NOT SET'))
print("GOOGLE_CSE_ID:", os.getenv('GOOGLE_CSE_ID', 'NOT SET'))
print("GOOGLE_AI_API_KEY:", os.getenv('GOOGLE_AI_API_KEY', 'NOT SET'))
print("SPARK_API_KEY:", os.getenv('SPARK_API_KEY', 'NOT SET'))
EOF

source venv/bin/activate
python test_env.py
```

### 4. 手动测试web_app是否能读取环境变量

```bash
cd /srv/jp-ppt
source venv/bin/activate

# 设置环境变量
export GOOGLE_API_KEY="你的密钥"
export GOOGLE_CSE_ID="你的CSE_ID"
export GOOGLE_AI_API_KEY="你的Gemini密钥"
export SPARK_API_KEY="你的Spark密钥"

# 测试导入
python -c "from web_app import app; import os; print('GOOGLE_API_KEY:', bool(os.getenv('GOOGLE_API_KEY'))); print('GOOGLE_CSE_ID:', bool(os.getenv('GOOGLE_CSE_ID'))); print('GOOGLE_AI_API_KEY:', bool(os.getenv('GOOGLE_AI_API_KEY'))); print('SPARK_API_KEY:', bool(os.getenv('SPARK_API_KEY')))"
```

### 5. 检查systemd服务文件格式

确保格式正确，每行一个Environment：
```ini
[Service]
User=Zhuanz
WorkingDirectory=/srv/jp-ppt
Environment="PATH=/srv/jp-ppt/venv/bin"
Environment="GOOGLE_API_KEY=AIzaSy..."
Environment="GOOGLE_CSE_ID=你的CSE_ID"
Environment="GOOGLE_AI_API_KEY=你的Gemini密钥"
Environment="SPARK_API_KEY=你的Spark密钥"
Environment="SPARK_BASE_URL=https://spark-api-open.xf-yun.com/v2"
Environment="SPARK_MODEL=spark-x"
ExecStart=/srv/jp-ppt/venv/bin/gunicorn -w 2 -b 127.0.0.1:5000 --timeout 300 web_app:app
```

### 6. 使用EnvironmentFile（推荐方法）

如果不想在服务文件中硬编码密钥：

1. 创建环境变量文件：
```bash
sudo nano /etc/systemd/system/ppt-enhancer.env
```

内容：
```
GOOGLE_API_KEY=你的Google_API_KEY
GOOGLE_CSE_ID=你的Google_CSE_ID
GOOGLE_AI_API_KEY=你的Google_AI_API_KEY
SPARK_API_KEY=你的Spark_API_KEY
SPARK_BASE_URL=https://spark-api-open.xf-yun.com/v2
SPARK_MODEL=spark-x
```

2. 设置权限：
```bash
sudo chmod 600 /etc/systemd/system/ppt-enhancer.env
```

3. 在服务文件中添加：
```ini
[Service]
...
EnvironmentFile=/etc/systemd/system/ppt-enhancer.env
...
```

4. 重新加载并重启：
```bash
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer
```

### 7. 验证

```bash
# 检查服务状态
sudo systemctl status ppt-enhancer

# 测试API
curl http://34.168.121.40/api/health | python -m json.tool
```

应该看到：
```json
{
    "server_google_api_configured": true,
    "server_google_ai_configured": true,
    "server_spark_api_configured": true,
    ...
}
```

