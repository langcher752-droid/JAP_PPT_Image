# 修复404错误

## 问题
- ✅ 可以连接到服务器（不再是超时）
- ❌ 返回404 Not Found

说明防火墙和Nginx都正常，但路由配置有问题。

## 排查步骤

### 1. 检查Nginx配置

```bash
# 查看完整配置
sudo cat /etc/nginx/sites-available/ppt-enhancer

# 检查是否有location /api/配置
sudo grep -A 10 "location /api/" /etc/nginx/sites-available/ppt-enhancer
```

### 2. 检查后端服务

```bash
# 检查服务状态
sudo systemctl status ppt-enhancer

# 测试后端API（直接访问）
curl http://127.0.0.1:5000/api/health

# 检查端口监听
sudo netstat -tlnp | grep 5000
```

### 3. 检查Nginx访问日志

```bash
# 查看访问日志
sudo tail -20 /var/log/nginx/access.log

# 查看错误日志
sudo tail -20 /var/log/nginx/error.log
```

### 4. 测试本地Nginx代理

```bash
# 测试通过Nginx访问API
curl http://127.0.0.1/api/health

# 测试根路径
curl http://127.0.0.1/
```

## 可能的问题和解决方案

### 问题1：Nginx配置中缺少location /api/块

**检查配置：**
```bash
sudo cat /etc/nginx/sites-available/ppt-enhancer
```

**应该包含：**
```nginx
location /api/ {
    proxy_pass http://127.0.0.1:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
}
```

### 问题2：server_name不匹配

**检查：**
```bash
sudo grep server_name /etc/nginx/sites-available/ppt-enhancer
```

**应该包含实际IP或通配符：**
```nginx
server_name rancho.website www.rancho.website 136.118.201.245 _;
```

### 问题3：Nginx配置未正确加载

```bash
# 检查启用的配置
ls -la /etc/nginx/sites-enabled/

# 确保有软链接
sudo ln -s /etc/nginx/sites-available/ppt-enhancer /etc/nginx/sites-enabled/ppt-enhancer

# 测试配置
sudo nginx -t

# 重载Nginx
sudo systemctl reload nginx
```

### 问题4：后端服务未运行

```bash
# 检查服务
sudo systemctl status ppt-enhancer

# 如果未运行，启动它
sudo systemctl start ppt-enhancer

# 测试后端
curl http://127.0.0.1:5000/api/health
```

## 完整的Nginx配置示例

```nginx
server {
    listen 80;
    server_name rancho.website www.rancho.website 136.118.201.245 _;
    
    client_max_body_size 100M;
    
    # 增加超时时间
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    send_timeout 600s;
    
    # API请求代理到后端
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
    
    # 静态文件
    root /srv/jp-ppt;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

## 快速诊断脚本

```bash
echo "=== 1. 后端服务状态 ==="
sudo systemctl status ppt-enhancer --no-pager | head -5
echo ""

echo "=== 2. 后端API测试 ==="
curl -s http://127.0.0.1:5000/api/health | head -c 100
echo ""
echo ""

echo "=== 3. Nginx配置检查 ==="
sudo grep -E "location /api/|proxy_pass" /etc/nginx/sites-available/ppt-enhancer
echo ""

echo "=== 4. 测试本地Nginx代理 ==="
curl -s http://127.0.0.1/api/health | head -c 100
echo ""
echo ""

echo "=== 5. Nginx访问日志 ==="
sudo tail -5 /var/log/nginx/access.log
echo ""

echo "=== 6. Nginx错误日志 ==="
sudo tail -5 /var/log/nginx/error.log
```

## 修复步骤

### 步骤1：检查后端服务

```bash
# 测试后端
curl http://127.0.0.1:5000/api/health

# 如果失败，检查服务
sudo systemctl status ppt-enhancer
sudo systemctl restart ppt-enhancer
```

### 步骤2：检查Nginx配置

```bash
# 查看配置
sudo cat /etc/nginx/sites-available/ppt-enhancer

# 确保有location /api/块
# 确保proxy_pass指向 http://127.0.0.1:5000
```

### 步骤3：修复配置（如果需要）

```bash
# 编辑配置
sudo nano /etc/nginx/sites-available/ppt-enhancer

# 确保包含：
# location /api/ {
#     proxy_pass http://127.0.0.1:5000;
#     ...
# }
```

### 步骤4：重载Nginx

```bash
# 测试配置
sudo nginx -t

# 重载
sudo systemctl reload nginx

# 测试
curl http://127.0.0.1/api/health
curl http://136.118.201.245/api/health
```

## 验证修复

修复后，应该看到：

```bash
$ curl http://136.118.201.245/api/health
{"status":"ok","message":"PPT图片增强服务运行正常",...}
```

而不是404错误。




