# 新服务器部署指南

## 服务器信息
- 实例名：`instance-20251230-121152`
- 区域：`europe-west2-a`
- 内网IP：`10.154.0.2`
- 公网IP：`34.142.75.113`
- SSH命令：`gcloud compute ssh --zone "europe-west2-a" "instance-20251230-121152" --project "project-c9bc7311-141d-4b19-8bb"`

## 部署步骤

### 1. 连接到新服务器

```bash
gcloud compute ssh --zone "europe-west2-a" "instance-20251230-121152" --project "project-c9bc7311-141d-4b19-8bb"
```

### 2. 更新系统并安装基础软件

```bash
sudo apt update
sudo apt upgrade -y
sudo apt install -y python3 python3-pip python3-venv nginx git
```

### 3. 创建项目目录

```bash
sudo mkdir -p /srv/jp-ppt
sudo chown $USER:$USER /srv/jp-ppt
cd /srv/jp-ppt
```

### 4. 克隆或上传代码

**如果使用Git：**
```bash
git clone https://github.com/langcher752-droid/JAP_PPT_Image.git .
```

**或者手动上传文件：**
- `main.py`
- `web_app.py`
- `index.html`
- `requirements-web.txt`
- `config.json.example`（重命名为 `config.json` 并填写API密钥）

### 5. 创建虚拟环境并安装依赖

```bash
python3 -m venv venv
source venv/bin/activate
pip install --upgrade pip
pip install -r requirements-web.txt
```

### 6. 配置API密钥

```bash
# 复制示例配置文件
cp config.json.example config.json

# 编辑配置文件（使用nano或vim）
nano config.json

# 或者使用环境变量（推荐）
# 在systemd服务文件中配置环境变量
```

### 7. 配置Nginx

创建Nginx配置文件：
```bash
sudo nano /etc/nginx/sites-available/ppt-enhancer
```

**配置文件内容：**
```nginx
server {
    listen 80;
    listen [::]:80;
    server_name www.rancho.website rancho.website 34.142.75.113;

    # 增加客户端上传大小限制
    client_max_body_size 100M;
    
    # 增加超时时间（重要！）
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    send_timeout 600s;

    # 前端文件
    location / {
        root /srv/jp-ppt;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    # API后端
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 增加API请求的超时时间
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
}
```

启用配置：
```bash
sudo ln -s /etc/nginx/sites-available/ppt-enhancer /etc/nginx/sites-enabled/
sudo rm -f /etc/nginx/sites-enabled/default  # 删除默认配置
sudo nginx -t  # 测试配置
sudo systemctl reload nginx
```

### 8. 创建systemd服务

创建服务文件：
```bash
sudo nano /etc/systemd/system/ppt-enhancer.service
```

**服务文件内容：**
```ini
[Unit]
Description=PPT Image Enhancer API
After=network.target

[Service]
User=你的用户名
Group=你的用户组
WorkingDirectory=/srv/jp-ppt
Environment="PATH=/srv/jp-ppt/venv/bin"
Environment="PYTHONPATH=/srv/jp-ppt"

# API密钥（使用环境变量，更安全）
Environment="GOOGLE_API_KEY=你的Google API密钥"
Environment="GOOGLE_CSE_ID=你的Google CSE ID"
Environment="GOOGLE_AI_API_KEY=你的Google AI API密钥"
Environment="SPARK_API_KEY=你的Spark API密钥"
Environment="SPARK_BASE_URL=https://spark-api-open.xf-yun.com/v2"
Environment="SPARK_MODEL=spark-x"

# Gunicorn配置（增加超时时间，减少worker数量以节省内存）
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 1 --timeout 600 --max-requests 100 --max-requests-jitter 10 web_app:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**注意：**
- 将 `你的用户名` 替换为实际用户名（运行 `whoami` 查看）
- 将 `你的用户组` 替换为实际用户组（运行 `id -gn` 查看）
- 填写所有API密钥

启用并启动服务：
```bash
sudo systemctl daemon-reload
sudo systemctl enable ppt-enhancer
sudo systemctl start ppt-enhancer
sudo systemctl status ppt-enhancer
```

### 9. 配置HTTPS（可选但推荐）

```bash
sudo apt install certbot python3-certbot-nginx
sudo certbot --nginx -d www.rancho.website -d rancho.website
```

**注意：** 确保DNS已指向新服务器的IP地址（34.142.75.113）

### 10. 配置防火墙

```bash
# 允许HTTP和HTTPS
sudo ufw allow 80/tcp
sudo ufw allow 443/tcp
sudo ufw allow 22/tcp  # SSH
sudo ufw enable
```

### 11. 更新DNS记录

将域名 `www.rancho.website` 和 `rancho.website` 的A记录指向新IP：`34.142.75.113`

### 12. 测试服务

```bash
# 测试本地API
curl http://127.0.0.1:5000/api/health

# 测试公网访问
curl http://34.142.75.113/api/health
```

## 优化配置（减少内存使用）

### 1. 减少Gunicorn worker数量

在systemd服务文件中，使用 `--workers 1` 而不是 `--workers 2`，减少内存占用。

### 2. 添加内存限制（可选）

如果使用Docker或需要限制内存，可以在systemd服务文件中添加：
```ini
[Service]
...
MemoryLimit=512M
```

### 3. 定期清理临时文件

代码已经包含自动清理功能，但可以添加定时任务：
```bash
# 编辑crontab
crontab -e

# 添加每天凌晨清理临时文件
0 2 * * * find /srv/jp-ppt/temp_images -type f -mtime +1 -delete
0 2 * * * find /srv/jp-ppt/uploads -type f -mtime +1 -delete
0 2 * * * find /srv/jp-ppt/outputs -type f -mtime +1 -delete
```

## 故障排查

### 检查服务状态
```bash
sudo systemctl status ppt-enhancer
sudo journalctl -u ppt-enhancer -n 50 --no-pager
```

### 检查Nginx状态
```bash
sudo systemctl status nginx
sudo tail -50 /var/log/nginx/error.log
```

### 检查内存使用
```bash
free -h
top
```

### 测试API
```bash
curl http://127.0.0.1:5000/api/health
```

## 从旧服务器迁移数据

如果需要迁移旧服务器的配置：

```bash
# 在旧服务器上
cd /srv/jp-ppt
tar czf config-backup.tar.gz config.json

# 下载到本地
# 然后上传到新服务器

# 在新服务器上
cd /srv/jp-ppt
tar xzf config-backup.tar.gz
```

## 完成！

部署完成后，访问 `http://34.142.75.113` 或配置的域名即可使用服务。

