# 修复服务启动失败（退出码3）

## 问题
服务启动失败，退出码为3（NOTIMPLEMENTED），通常表示：
1. Gunicorn命令语法错误
2. Python代码导入错误
3. 模块找不到
4. 工作目录或路径问题

## 排查步骤

### 1. 查看详细错误日志

```bash
# 查看完整的错误信息
sudo journalctl -u ppt-enhancer -n 100 --no-pager

# 查看最近的错误（实时）
sudo journalctl -u ppt-enhancer -f
```

### 2. 检查systemd服务文件

```bash
sudo cat /etc/systemd/system/ppt-enhancer.service
```

**确保服务文件内容正确：**
```ini
[Unit]
Description=PPT Image Enhancer API
After=network.target

[Service]
User=你的用户名
Group=你的用户组
WorkingDirectory=/srv/jp-ppt
Environment="PATH=/srv/jp-ppt/venv/bin"
Environment="PYTHONPATH=/srv/jp-ppt"
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 2 --timeout 300 web_app:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

### 3. 手动测试启动

```bash
cd /srv/jp-ppt
source venv/bin/activate

# 测试Python导入
python -c "from web_app import app; print('Import OK')"

# 如果导入失败，查看具体错误
python -c "import web_app"
```

### 4. 手动启动Gunicorn测试

```bash
cd /srv/jp-ppt
source venv/bin/activate

# 手动启动（查看详细错误）
gunicorn --bind 127.0.0.1:5000 --workers 2 --timeout 300 web_app:app
```

**如果手动启动失败，错误信息会直接显示在终端。**

### 5. 检查依赖

```bash
cd /srv/jp-ppt
source venv/bin/activate

# 检查关键依赖
pip list | grep -E "flask|gunicorn|python-pptx|requests|pillow"

# 如果缺少依赖，安装
pip install -r requirements-web.txt
```

### 6. 检查文件权限

```bash
# 检查工作目录权限
ls -la /srv/jp-ppt/

# 确保用户有权限
sudo chown -R 你的用户名:你的用户组 /srv/jp-ppt
chmod +x /srv/jp-ppt/venv/bin/gunicorn
```

### 7. 检查Python版本

```bash
cd /srv/jp-ppt
source venv/bin/activate

# 检查Python版本
python --version

# 应该是Python 3.8或更高版本
```

### 8. 检查web_app.py文件

```bash
# 检查文件是否存在
ls -la /srv/jp-ppt/web_app.py

# 检查文件语法
cd /srv/jp-ppt
source venv/bin/activate
python -m py_compile web_app.py
```

## 常见问题解决

### 问题1：Gunicorn命令语法错误

**错误示例：**
```ini
ExecStart=/srv/jp-ppt/venv/bin/gunicorn -w 2 -b 127.0.0.1:5000 web_app:app
```

**正确格式：**
```ini
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 2 --timeout 300 web_app:app
```

### 问题2：模块导入错误

如果 `web_app.py` 导入 `main.py` 失败：
```bash
# 检查main.py是否存在
ls -la /srv/jp-ppt/main.py

# 测试导入
cd /srv/jp-ppt
source venv/bin/activate
python -c "from main import PPTImageEnhancer, load_config; print('OK')"
```

### 问题3：工作目录错误

确保systemd服务文件中的 `WorkingDirectory` 正确：
```ini
WorkingDirectory=/srv/jp-ppt
```

### 问题4：环境变量未设置

如果代码需要环境变量，在systemd服务文件中添加：
```ini
Environment="GOOGLE_API_KEY=your_key"
Environment="GOOGLE_CSE_ID=your_id"
# ... 其他环境变量
```

## 修复命令（按顺序执行）

```bash
# 1. 进入项目目录
cd /srv/jp-ppt
source venv/bin/activate

# 2. 测试Python导入
python -c "from web_app import app; print('Import OK')"

# 3. 如果导入成功，测试手动启动
gunicorn --bind 127.0.0.1:5000 --workers 2 --timeout 300 web_app:app

# 4. 如果手动启动成功，检查systemd服务文件
sudo cat /etc/systemd/system/ppt-enhancer.service

# 5. 修复服务文件后，重新加载systemd
sudo systemctl daemon-reload

# 6. 启动服务
sudo systemctl start ppt-enhancer

# 7. 检查状态
sudo systemctl status ppt-enhancer
```

## 如果仍然失败

请提供以下信息：
1. `sudo journalctl -u ppt-enhancer -n 100 --no-pager` 的完整输出
2. `python -c "from web_app import app"` 的输出
3. `gunicorn --bind 127.0.0.1:5000 --workers 2 --timeout 300 web_app:app` 的输出（如果手动启动失败）
4. `cat /etc/systemd/system/ppt-enhancer.service` 的内容

