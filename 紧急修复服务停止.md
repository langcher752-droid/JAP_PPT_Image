# 紧急修复：后端服务停止

## 问题
- `curl http://127.0.0.1:5000` 连接被拒绝
- 后端服务可能已停止

## 立即修复步骤

### 1. 检查服务状态

```bash
# 检查服务状态
sudo systemctl status ppt-enhancer

# 查看详细日志
sudo journalctl -u ppt-enhancer -n 100 --no-pager
```

### 2. 检查端口监听

```bash
# 检查端口5000是否被监听
sudo netstat -tlnp | grep 5000

# 如果没有输出，说明服务未运行
```

### 3. 重启服务

```bash
# 重启服务
sudo systemctl restart ppt-enhancer

# 等待几秒后检查状态
sleep 3
sudo systemctl status ppt-enhancer
```

### 4. 如果启动失败，查看错误

```bash
# 查看最近的错误
sudo journalctl -u ppt-enhancer -n 50 --no-pager | tail -20

# 检查服务配置文件
sudo cat /etc/systemd/system/ppt-enhancer.service
```

### 5. 验证修复

```bash
# 检查端口
sudo netstat -tlnp | grep 5000

# 测试API
curl http://127.0.0.1:5000/api/health

# 测试Nginx代理
curl http://127.0.0.1/api/health
```

## 如果服务无法启动

### 检查1：服务配置文件

```bash
# 检查配置文件语法
sudo systemd-analyze verify /etc/systemd/system/ppt-enhancer.service

# 查看完整配置
sudo cat /etc/systemd/system/ppt-enhancer.service
```

### 检查2：手动启动测试

```bash
cd /srv/jp-ppt
source venv/bin/activate

# 手动启动（在另一个端口测试）
gunicorn --bind 127.0.0.1:5001 --workers 4 --timeout 600 web_app:app

# 如果手动启动成功，说明代码没问题，是systemd配置问题
# 按 Ctrl+C 停止
```

### 检查3：查看系统资源

```bash
# 检查内存
free -h

# 检查磁盘空间
df -h

# 检查系统日志
sudo dmesg | tail -20
```

## 快速修复命令序列

```bash
# 1. 检查状态
sudo systemctl status ppt-enhancer

# 2. 重启服务
sudo systemctl restart ppt-enhancer

# 3. 等待并检查
sleep 5
sudo systemctl status ppt-enhancer | head -15

# 4. 检查端口
sudo netstat -tlnp | grep 5000

# 5. 测试API
curl http://127.0.0.1:5000/api/health

# 6. 如果失败，查看错误
sudo journalctl -u ppt-enhancer -n 50 --no-pager
```

## 常见问题

### 问题1：服务立即退出

**可能原因：** 代码错误、配置错误、依赖缺失

**解决：**
```bash
# 查看详细错误
sudo journalctl -u ppt-enhancer -n 100 --no-pager

# 手动运行查看错误
cd /srv/jp-ppt
source venv/bin/activate
python web_app.py
```

### 问题2：端口被占用

**可能原因：** 另一个进程在使用5000端口

**解决：**
```bash
# 查找占用端口的进程
sudo lsof -i :5000
# 或
sudo fuser 5000/tcp

# 如果发现其他进程，停止它或修改服务配置使用其他端口
```

### 问题3：权限问题

**可能原因：** 用户权限不足

**解决：**
```bash
# 检查文件权限
ls -la /srv/jp-ppt
ls -la /srv/jp-ppt/venv/bin/gunicorn

# 检查服务文件中的User设置
sudo grep User /etc/systemd/system/ppt-enhancer.service
```

## 如果问题持续

请提供以下信息：

1. `sudo systemctl status ppt-enhancer` 的完整输出
2. `sudo journalctl -u ppt-enhancer -n 100 --no-pager` 的输出
3. `sudo netstat -tlnp | grep 5000` 的输出
4. `free -h` 的输出
5. `df -h` 的输出

