# 排查防火墙规则冲突

## 问题
防火墙规则已创建，但仍然超时。

## 排查步骤

### 1. 检查是否有deny规则阻止连接

```bash
# 列出所有防火墙规则
gcloud compute firewall-rules list

# 查找deny规则（优先级更高）
gcloud compute firewall-rules list --format="table(name,direction,priority,denied,allowed,sourceRanges)"

# 查找是否有默认deny规则
gcloud compute firewall-rules list --filter="direction=INGRESS AND priority<1000"
```

### 2. 检查实例的网络配置

```bash
# 查看实例的网络接口
gcloud compute instances describe instance-20251228-095410 \
    --zone europe-west2-a \
    --format="get(networkInterfaces[0].network)"

# 查看实例的完整网络配置
gcloud compute instances describe instance-20251228-095410 \
    --zone europe-west2-a \
    --format="yaml(networkInterfaces)"
```

### 3. 检查实例的网络标签

```bash
# 查看实例的标签
gcloud compute instances describe instance-20251228-095410 \
    --zone europe-west2-a \
    --format="get(tags.items)"

# 如果规则使用了targetTags，确保实例有相应标签
```

### 4. 检查是否有其他网络限制

```bash
# 查看VPC网络配置
gcloud compute networks describe default

# 查看子网配置
gcloud compute networks subnets list
```

### 5. 检查实例的外部IP配置

```bash
# 查看实例的外部IP
gcloud compute instances describe instance-20251228-095410 \
    --zone europe-west2-a \
    --format="get(networkInterfaces[0].accessConfigs[0].natIP)"

# 应该返回: 34.142.75.113
```

### 6. 测试从服务器内部访问外部IP

在服务器上运行：

```bash
# 测试从服务器内部访问自己的外部IP
curl -I http://34.142.75.113/
curl http://34.142.75.113/api/health

# 如果这个也超时，说明可能是路由问题
```

### 7. 检查是否有负载均衡器或代理

```bash
# 检查是否有负载均衡器
gcloud compute forwarding-rules list

# 检查是否有其他代理服务
```

## 可能的解决方案

### 方案1：检查规则优先级

如果有更高优先级的deny规则，需要：
1. 删除或修改deny规则
2. 或者提高allow规则的优先级

```bash
# 创建更高优先级的规则
gcloud compute firewall-rules create allow-http-high \
    --allow tcp:80 \
    --source-ranges 0.0.0.0/0 \
    --priority 900 \
    --description "Allow HTTP traffic (high priority)"

gcloud compute firewall-rules create allow-https-high \
    --allow tcp:443 \
    --source-ranges 0.0.0.0/0 \
    --priority 900 \
    --description "Allow HTTPS traffic (high priority)"
```

### 方案2：检查实例是否在正确的网络中

确保实例在 `default` 网络中，防火墙规则应用到该网络。

### 方案3：等待规则生效

有时规则需要几分钟才能完全生效。等待2-3分钟后重试。

### 方案4：检查GCP项目设置

```bash
# 查看项目信息
gcloud config get-value project

# 确保在正确的项目中
gcloud config set project project-c9bc7311-141d-4b19-8bb
```

### 方案5：使用gcloud测试连接

```bash
# 测试从GCP内部访问（如果可能）
gcloud compute ssh instance-20251228-095410 \
    --zone europe-west2-a \
    --command "curl -I http://34.142.75.113/"
```

## 快速诊断脚本

运行以下命令获取完整信息：

```bash
echo "=== 1. 所有防火墙规则 ==="
gcloud compute firewall-rules list --format="table(name,direction,priority,denied,allowed,sourceRanges)"
echo ""

echo "=== 2. 实例网络配置 ==="
gcloud compute instances describe instance-20251228-095410 \
    --zone europe-west2-a \
    --format="get(networkInterfaces[0].network)"
echo ""

echo "=== 3. 实例外部IP ==="
gcloud compute instances describe instance-20251228-095410 \
    --zone europe-west2-a \
    --format="get(networkInterfaces[0].accessConfigs[0].natIP)"
echo ""

echo "=== 4. 实例标签 ==="
gcloud compute instances describe instance-20251228-095410 \
    --zone europe-west2-a \
    --format="get(tags.items)"
echo ""

echo "=== 5. 检查deny规则 ==="
gcloud compute firewall-rules list --filter="direction=INGRESS AND denied" --format="table(name,priority,denied)"
```

## 如果仍然无法解决

可能需要：
1. 检查GCP控制台的"网络"部分，查看是否有其他限制
2. 检查实例的"网络接口"配置
3. 联系GCP支持（如果是企业账户）

## 临时解决方案：使用SSH隧道

如果防火墙问题无法立即解决，可以使用SSH隧道临时访问：

```bash
# 在本地电脑上创建SSH隧道
ssh -L 8080:127.0.0.1:80 -L 8443:127.0.0.1:443 \
    -N -f instance-20251228-095410 \
    --zone europe-west2-a

# 然后访问
# http://localhost:8080/
# https://localhost:8443/
```




