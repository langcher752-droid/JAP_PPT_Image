# 16G内存服务器优化配置

## 服务器配置
- 内存：16GB（已升级）
- 推荐Worker数量：4-8个

## 优化配置

### 1. Gunicorn 配置（使用更多Worker）

编辑 systemd 服务文件：
```bash
sudo nano /etc/systemd/system/ppt-enhancer.service
```

**推荐配置（4个worker，平衡性能和稳定性）：**
```ini
[Unit]
Description=PPT Image Enhancer API
After=network.target

[Service]
User=你的用户名
Group=你的用户组
WorkingDirectory=/srv/jp-ppt
Environment="PATH=/srv/jp-ppt/venv/bin"
Environment="PYTHONPATH=/srv/jp-ppt"
Environment="GOOGLE_API_KEY=你的密钥"
Environment="GOOGLE_CSE_ID=你的CSE ID"
Environment="GOOGLE_AI_API_KEY=你的密钥"
Environment="SPARK_API_KEY=你的密钥"
Environment="SPARK_BASE_URL=https://spark-api-open.xf-yun.com/v2"
Environment="SPARK_MODEL=spark-x"

# 4个worker配置（推荐）
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 4 --timeout 600 --max-requests 1000 --max-requests-jitter 50 --worker-class sync web_app:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**高性能配置（8个worker，适合高并发）：**
```ini
# 如果并发请求很多，可以使用8个worker
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 8 --timeout 600 --max-requests 1000 --max-requests-jitter 50 --worker-class sync web_app:app
```

**应用配置：**
```bash
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer
sudo systemctl status ppt-enhancer
```

### 2. 监控内存使用

```bash
# 查看内存使用情况
free -h

# 查看每个worker的内存使用
ps aux | grep gunicorn

# 实时监控
watch -n 1 'ps aux | grep gunicorn | grep -v grep'
```

### 3. 性能测试

```bash
# 测试并发处理能力
ab -n 100 -c 10 http://127.0.0.1:5000/api/health

# 查看worker状态
curl http://127.0.0.1:5000/api/health
```

### 4. 根据实际情况调整

**如果内存使用率低（<50%）：**
- 可以增加worker数量到6-8个
- 提升并发处理能力

**如果内存使用率高（>80%）：**
- 减少worker数量到2-4个
- 或者增加 `--max-requests` 值，让worker更频繁重启

**如果CPU使用率高：**
- 减少worker数量
- 或者使用异步worker（需要修改代码）

## Worker数量选择

### 推荐配置：4个Worker
- ✅ 平衡性能和稳定性
- ✅ 可以同时处理4个请求
- ✅ 内存占用约1-1.5GB
- ✅ 适合大多数场景

### 高性能配置：8个Worker
- ✅ 可以同时处理8个请求
- ✅ 内存占用约2-3GB
- ✅ 适合高并发场景
- ⚠️ 需要监控内存和CPU使用

### 测试不同配置

```bash
# 测试4个worker
sudo nano /etc/systemd/system/ppt-enhancer.service
# 修改为 --workers 4
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer

# 运行一段时间后，查看性能
sudo journalctl -u ppt-enhancer --since "10 minutes ago" | grep -i "error\|timeout"

# 如果稳定，可以尝试增加到6-8个
```

## 其他优化建议

### 1. 增加系统缓存（可选）

```bash
# 查看当前swap配置
swapon --show

# 如果内存充足，可以减少swap使用
sudo sysctl vm.swappiness=10
```

### 2. 优化Python内存管理

在代码中已经包含：
- 自动清理临时文件
- 限制重试次数
- 及时释放资源

### 3. 监控和告警（可选）

```bash
# 安装监控工具
sudo apt install htop iotop

# 使用htop监控
htop
```

## 快速应用配置

```bash
# 1. 编辑服务文件
sudo nano /etc/systemd/system/ppt-enhancer.service

# 2. 修改ExecStart行为：
# ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 4 --timeout 600 --max-requests 1000 --max-requests-jitter 50 web_app:app

# 3. 应用配置
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer

# 4. 检查状态
sudo systemctl status ppt-enhancer
free -h
```

## 验证优化效果

```bash
# 1. 检查服务状态
sudo systemctl status ppt-enhancer

# 2. 查看worker进程
ps aux | grep gunicorn

# 3. 查看内存使用
free -h

# 4. 测试API
curl http://127.0.0.1:5000/api/health

# 5. 查看日志（确认没有错误）
sudo journalctl -u ppt-enhancer -n 50 --no-pager
```

## 总结

对于16GB内存的服务器：
- ✅ **推荐使用4个worker**：平衡性能和稳定性
- ✅ **可以增加到6-8个worker**：如果需要处理更多并发请求
- ✅ **监控内存使用**：确保不会超过80%
- ✅ **保持超时配置**：600秒超时，避免504错误

优化后，服务可以同时处理多个请求，性能大幅提升！

