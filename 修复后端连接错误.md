# 修复后端连接错误

## 问题分析

从Nginx错误日志可以看出：
- `Connection refused` - 后端服务（127.0.0.1:5000）未运行
- `upstream timed out` - 即使连接上，也出现超时

## 快速修复步骤

### 1. 检查后端服务状态

```bash
# 检查服务状态
sudo systemctl status ppt-enhancer

# 如果显示 inactive 或 failed，查看详细错误
sudo journalctl -u ppt-enhancer -n 100 --no-pager
```

### 2. 检查端口5000是否被监听

```bash
# 检查端口5000
sudo netstat -tlnp | grep 5000
# 或
sudo ss -tlnp | grep 5000

# 如果没有输出，说明服务未运行
```

### 3. 启动/重启后端服务

```bash
# 如果服务未运行，启动它
sudo systemctl start ppt-enhancer

# 如果服务运行但有问题，重启它
sudo systemctl restart ppt-enhancer

# 检查状态
sudo systemctl status ppt-enhancer
```

### 4. 如果服务启动失败，检查配置

```bash
# 检查服务配置文件
sudo nano /etc/systemd/system/ppt-enhancer.service

# 确保以下内容正确：
# - User 和 Group 是正确的用户名
# - WorkingDirectory 路径存在
# - ExecStart 路径正确
# - 环境变量已设置
```

### 5. 手动测试后端服务

```bash
# 切换到项目目录
cd /srv/jp-ppt

# 激活虚拟环境
source venv/bin/activate

# 手动启动Gunicorn测试
gunicorn --bind 127.0.0.1:5000 --workers 4 --timeout 600 web_app:app

# 如果手动启动成功，说明代码没问题，可能是systemd配置问题
# 按 Ctrl+C 停止，然后修复systemd配置
```

### 6. 检查服务配置文件

```bash
# 查看服务文件
sudo cat /etc/systemd/system/ppt-enhancer.service

# 确保格式正确，特别是：
# - User=你的用户名（运行 whoami 查看）
# - Group=你的用户组（运行 id -gn 查看）
# - WorkingDirectory=/srv/jp-ppt
# - ExecStart 路径正确
```

### 7. 修复常见问题

#### 问题A：用户/组错误

```bash
# 查看当前用户
whoami
id -gn

# 编辑服务文件，修改User和Group
sudo nano /etc/systemd/system/ppt-enhancer.service
```

#### 问题B：路径错误

```bash
# 检查路径是否存在
ls -la /srv/jp-ppt
ls -la /srv/jp-ppt/venv/bin/gunicorn

# 如果不存在，检查实际路径
which gunicorn
```

#### 问题C：环境变量未设置

```bash
# 检查服务文件中的环境变量
sudo grep Environment /etc/systemd/system/ppt-enhancer.service

# 确保所有必要的环境变量都已设置
```

### 8. 重新加载并启动服务

```bash
# 重新加载systemd配置
sudo systemctl daemon-reload

# 启动服务
sudo systemctl start ppt-enhancer

# 启用开机自启
sudo systemctl enable ppt-enhancer

# 检查状态
sudo systemctl status ppt-enhancer
```

### 9. 验证修复

```bash
# 检查端口是否监听
sudo netstat -tlnp | grep 5000

# 测试API
curl http://127.0.0.1:5000/api/health

# 应该返回JSON响应，类似：
# {"status":"ok","message":"PPT图片增强服务运行正常",...}
```

### 10. 如果仍然失败，查看详细日志

```bash
# 查看服务日志
sudo journalctl -u ppt-enhancer -f

# 在另一个终端测试
curl http://127.0.0.1:5000/api/health

# 查看实时日志输出，找出具体错误
```

## 完整修复命令序列

```bash
# 1. 检查服务状态
sudo systemctl status ppt-enhancer

# 2. 查看错误日志
sudo journalctl -u ppt-enhancer -n 50 --no-pager

# 3. 检查配置文件
sudo cat /etc/systemd/system/ppt-enhancer.service

# 4. 检查用户和路径
whoami
id -gn
ls -la /srv/jp-ppt/venv/bin/gunicorn

# 5. 重新加载配置
sudo systemctl daemon-reload

# 6. 重启服务
sudo systemctl restart ppt-enhancer

# 7. 检查状态
sudo systemctl status ppt-enhancer

# 8. 检查端口
sudo netstat -tlnp | grep 5000

# 9. 测试API
curl http://127.0.0.1:5000/api/health

# 10. 如果成功，测试Nginx
curl http://127.0.0.1/api/health
curl https://www.rancho.website/api/health
```

## 常见错误和解决方案

### 错误1：`Failed to start ppt-enhancer.service: Unit ppt-enhancer.service has a bad unit file setting`

**原因：** systemd服务文件格式错误

**解决：**
```bash
# 检查服务文件语法
sudo systemd-analyze verify /etc/systemd/system/ppt-enhancer.service

# 修复格式错误（常见：缺少引号、路径错误等）
sudo nano /etc/systemd/system/ppt-enhancer.service
```

### 错误2：`Invalid user/group name`

**原因：** User或Group字段的值不正确

**解决：**
```bash
# 查看正确的用户名和组
whoami
id -gn

# 修改服务文件
sudo nano /etc/systemd/system/ppt-enhancer.service
# 修改 User= 和 Group= 行
```

### 错误3：`No such file or directory`

**原因：** 路径不存在

**解决：**
```bash
# 检查所有路径
ls -la /srv/jp-ppt
ls -la /srv/jp-ppt/venv/bin/gunicorn
ls -la /srv/jp-ppt/web_app.py

# 如果不存在，检查实际路径或重新安装
```

### 错误4：`ModuleNotFoundError`

**原因：** Python依赖未安装

**解决：**
```bash
cd /srv/jp-ppt
source venv/bin/activate
pip install -r requirements-web.txt
```

### 错误5：服务启动但立即退出

**原因：** 代码错误或配置问题

**解决：**
```bash
# 查看详细日志
sudo journalctl -u ppt-enhancer -n 100 --no-pager

# 手动运行查看错误
cd /srv/jp-ppt
source venv/bin/activate
python web_app.py
# 或
gunicorn --bind 127.0.0.1:5000 web_app:app
```

## 验证修复成功

修复后，应该看到：

```bash
$ sudo systemctl status ppt-enhancer
● ppt-enhancer.service - PPT Image Enhancer API
   Loaded: loaded (/etc/systemd/system/ppt-enhancer.service; enabled)
   Active: active (running) since ...
   
$ sudo netstat -tlnp | grep 5000
tcp  0  0  127.0.0.1:5000  0.0.0.0:*  LISTEN  12345/python

$ curl http://127.0.0.1:5000/api/health
{"status":"ok","message":"PPT图片增强服务运行正常",...}
```

## 如果问题仍然存在

请提供以下信息：

1. `sudo systemctl status ppt-enhancer` 的完整输出
2. `sudo journalctl -u ppt-enhancer -n 100 --no-pager` 的输出
3. `sudo cat /etc/systemd/system/ppt-enhancer.service` 的内容
4. `whoami` 和 `id -gn` 的输出
5. `ls -la /srv/jp-ppt/venv/bin/gunicorn` 的输出

