# 修复504超时和API错误

## 问题
1. Google API 返回 429（配额超限）
2. Spark API 返回 500（服务器错误）
3. 网站显示 504 Gateway Timeout（处理时间过长）

## 解决方案

### 1. 修复 Nginx 超时配置

编辑 Nginx 配置文件：
```bash
sudo nano /etc/nginx/sites-available/ppt-enhancer
```

**添加或修改以下配置：**
```nginx
server {
    listen 80;
    listen [::]:80;
    server_name www.rancho.website rancho.website;

    # 增加客户端上传大小限制
    client_max_body_size 100M;
    
    # 增加超时时间（重要！）
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    send_timeout 600s;

    location / {
        root /srv/jp-ppt;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 增加API请求的超时时间
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
}
```

**如果使用HTTPS，也要在443端口的配置中添加：**
```nginx
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.rancho.website rancho.website;

    # SSL配置...
    
    # 增加超时时间
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    send_timeout 600s;
    
    client_max_body_size 100M;

    location / {
        root /srv/jp-ppt;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 增加API请求的超时时间
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
}
```

**应用配置：**
```bash
# 测试配置
sudo nginx -t

# 重新加载Nginx
sudo systemctl reload nginx
```

### 2. 增加 Gunicorn 超时时间

编辑 systemd 服务文件：
```bash
sudo nano /etc/systemd/system/ppt-enhancer.service
```

**确保超时时间足够长：**
```ini
[Service]
...
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 2 --timeout 600 web_app:app
...
```

**应用更改：**
```bash
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer
```

### 3. 改进代码以减少重试（可选）

当 API 都失败时，代码会不断重试，导致超时。可以：
- 减少重试次数
- 更快地使用备用方案
- 跳过无法获取图片的页面

## 快速修复命令

```bash
# 1. 编辑 Nginx 配置
sudo nano /etc/nginx/sites-available/ppt-enhancer

# 2. 添加超时配置（见上面的配置）

# 3. 测试配置
sudo nginx -t

# 4. 重新加载 Nginx
sudo systemctl reload nginx

# 5. 检查 Gunicorn 超时时间
sudo cat /etc/systemd/system/ppt-enhancer.service | grep timeout

# 6. 如果超时时间不足，编辑服务文件
sudo nano /etc/systemd/system/ppt-enhancer.service
# 修改为：--timeout 600

# 7. 重启服务
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer

# 8. 检查服务状态
sudo systemctl status ppt-enhancer
```

## 验证修复

修复后，处理PPT时应该：
1. 不再出现 504 超时错误
2. 即使 API 失败，也能在合理时间内完成处理
3. 使用备用方案（Google爬虫）获取图片

## 关于 API 配额问题

如果 Google API 配额用完：
1. 等待24小时后重置（免费配额）
2. 或升级到付费计划
3. 代码会自动使用 Google 爬虫作为备用方案

如果 Spark API 返回 500：
1. 检查 API 密钥是否正确
2. 检查网络连接
3. 代码会自动跳过并使用其他方案

