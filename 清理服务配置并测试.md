# 清理服务配置并测试连接

## 发现的问题

服务配置文件中有重复的 `[Service]` 和 `User` 行，虽然服务能运行，但应该清理。

## 修复步骤

### 1. 清理服务配置文件

```bash
sudo nano /etc/systemd/system/ppt-enhancer.service
```

**正确的配置应该是：**
```ini
[Unit]
Description=PPT Image Enhancer API
After=network.target

[Service]
User=Zhuanz
Group=Zhuanz
WorkingDirectory=/srv/jp-ppt
Environment="PATH=/srv/jp-ppt/venv/bin"
Environment="PYTHONPATH=/srv/jp-ppt"
Environment="GOOGLE_API_KEY=AIzaSyApKXVeQl6o56N3coPK_kT7TXzZ0BdR9LQ"
Environment="GOOGLE_CSE_ID=b069dc11621844ca2"
Environment="GOOGLE_AI_API_KEY=AIzaSyApKXVeQl6o56N3coPK_kT7TXzZ0BdR9LQ"
Environment="SPARK_API_KEY=dLzBPSzLirFPwwgyOkpC:xTAVPfHtBINmeNRsGScT"
Environment="SPARK_BASE_URL=https://spark-api-open.xf-yun.com/v2"
Environment="SPARK_MODEL=spark-x"
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 4 --timeout 600 --max-requests 1000 --max-requests-jitter 50 web_app:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**注意：** 删除重复的 `[Service]` 和 `User` 行，只保留一个。

### 2. 重新加载配置

```bash
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer
sudo systemctl status ppt-enhancer
```

### 3. 测试后端API

```bash
# 测试本地API
curl http://127.0.0.1:5000/api/health

# 应该返回JSON响应
```

### 4. 测试Nginx连接

```bash
# 测试通过Nginx访问API
curl http://127.0.0.1/api/health

# 测试HTTPS（如果已配置）
curl https://127.0.0.1/api/health -k

# 测试公网访问
curl https://www.rancho.website/api/health
```

### 5. 检查Nginx错误日志

```bash
# 查看最新错误（应该没有新的连接拒绝错误）
sudo tail -20 /var/log/nginx/error.log

# 如果还有错误，查看详细日志
sudo tail -50 /var/log/nginx/error.log | grep -i "error\|refused\|timeout"
```

### 6. 测试网站访问

在浏览器中访问：
- `https://www.rancho.website/`
- `https://www.rancho.website/api/health`

应该能正常加载。

## 验证服务正常运行

运行以下命令确认一切正常：

```bash
# 1. 检查服务状态
sudo systemctl status ppt-enhancer | head -10

# 2. 检查端口监听
sudo netstat -tlnp | grep 5000

# 3. 检查worker进程
ps aux | grep gunicorn | grep -v grep

# 4. 测试API
curl http://127.0.0.1:5000/api/health

# 5. 测试Nginx代理
curl http://127.0.0.1/api/health

# 6. 检查Nginx状态
sudo systemctl status nginx | head -10

# 7. 查看最近的Nginx错误（应该没有新错误）
sudo tail -10 /var/log/nginx/error.log
```

## 如果还有问题

### 问题1：Nginx仍然显示连接拒绝

```bash
# 检查Nginx配置
sudo nginx -t

# 检查Nginx是否在监听
sudo netstat -tlnp | grep -E ':(80|443)'

# 重启Nginx
sudo systemctl restart nginx
```

### 问题2：网站仍然超时

```bash
# 检查防火墙
sudo ufw status

# 检查GCP防火墙规则（在GCP控制台）
# VPC网络 > 防火墙规则
# 确保允许 tcp:80 和 tcp:443

# 测试从服务器内部访问
curl -I http://127.0.0.1/
curl -I https://127.0.0.1/ -k
```

### 问题3：SSL证书问题

```bash
# 检查SSL证书
sudo certbot certificates

# 如果证书过期或不存在，重新申请
sudo certbot --nginx -d www.rancho.website
```

## 完成验证

如果所有测试都通过，网站应该可以正常访问了！

