# 修复502错误 - 服务器故障排查

## 问题描述
访问 `https://www.rancho.website/api/health` 返回 502 Bad Gateway 错误。

## 502错误原因
502错误表示Nginx无法连接到后端的Gunicorn服务，可能的原因：
1. Gunicorn服务没有运行
2. Gunicorn服务崩溃了
3. Nginx配置错误（端口不匹配）
4. 服务启动失败

## 排查步骤

### 1. 检查Gunicorn服务状态

```bash
sudo systemctl status ppt-enhancer
```

**如果服务没有运行：**
```bash
# 启动服务
sudo systemctl start ppt-enhancer

# 检查状态
sudo systemctl status ppt-enhancer
```

**如果服务启动失败：**
```bash
# 查看详细日志
sudo journalctl -u ppt-enhancer -n 100 --no-pager

# 查看最近的错误
sudo journalctl -u ppt-enhancer --since "10 minutes ago" | tail -50
```

### 2. 检查Gunicorn是否在监听端口

```bash
# 检查5000端口是否被监听
sudo netstat -tlnp | grep 5000
# 或者
sudo ss -tlnp | grep 5000
```

**应该看到类似：**
```
tcp  0  0  127.0.0.1:5000  0.0.0.0:*  LISTEN  <pid>/gunicorn
```

### 3. 测试本地连接

```bash
# 测试Gunicorn是否正常响应
curl http://127.0.0.1:5000/api/health
```

**如果返回JSON，说明Gunicorn正常。**
**如果连接被拒绝，说明Gunicorn没有运行。**

### 4. 检查Nginx配置

```bash
# 检查Nginx配置
sudo nginx -t

# 查看Nginx错误日志
sudo tail -50 /var/log/nginx/error.log
```

**检查 `/etc/nginx/sites-available/ppt-enhancer` 配置：**
```nginx
location /api/ {
    proxy_pass http://127.0.0.1:5000;
    proxy_set_header Host $host;
    proxy_set_header X-Real-IP $remote_addr;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
    proxy_set_header X-Forwarded-Proto $scheme;
}
```

### 5. 重启服务

```bash
# 重启Gunicorn服务
sudo systemctl restart ppt-enhancer

# 等待几秒后检查状态
sleep 3
sudo systemctl status ppt-enhancer

# 重启Nginx
sudo systemctl reload nginx
```

### 6. 如果服务持续崩溃

**检查Python环境和依赖：**
```bash
cd /srv/jp-ppt
source venv/bin/activate

# 测试导入
python -c "from web_app import app; print('OK')"

# 检查依赖
pip list | grep -E "flask|gunicorn"
```

**检查systemd服务文件：**
```bash
sudo cat /etc/systemd/system/ppt-enhancer.service
```

**确保包含：**
```ini
[Service]
User=你的用户名
WorkingDirectory=/srv/jp-ppt
Environment="PATH=/srv/jp-ppt/venv/bin"
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 2 --timeout 300 web_app:app
```

### 7. 手动启动测试

```bash
cd /srv/jp-ppt
source venv/bin/activate

# 手动启动Gunicorn（用于调试）
gunicorn --bind 127.0.0.1:5000 --workers 2 --timeout 300 web_app:app
```

**如果手动启动成功，说明代码没问题，可能是systemd配置问题。**
**如果手动启动失败，查看错误信息。**

### 8. 常见问题解决

**问题1：端口被占用**
```bash
# 查找占用5000端口的进程
sudo lsof -i :5000
# 或
sudo fuser -k 5000/tcp
```

**问题2：权限问题**
```bash
# 检查文件权限
ls -la /srv/jp-ppt/

# 确保用户有权限
sudo chown -R 你的用户名:你的用户名 /srv/jp-ppt
```

**问题3：环境变量未加载**
```bash
# 检查systemd服务文件中的Environment变量
sudo systemctl show ppt-enhancer | grep Environment
```

## 快速修复命令

```bash
# 1. 检查服务状态
sudo systemctl status ppt-enhancer

# 2. 如果服务停止，启动它
sudo systemctl start ppt-enhancer

# 3. 如果服务失败，查看日志
sudo journalctl -u ppt-enhancer -n 50 --no-pager

# 4. 测试本地连接
curl http://127.0.0.1:5000/api/health

# 5. 如果本地正常，重启Nginx
sudo systemctl reload nginx

# 6. 再次测试
curl https://www.rancho.website/api/health
```

## 验证修复

修复后，访问以下URL应该返回JSON：
- `https://www.rancho.website/api/health` - 应该返回JSON状态信息
- `http://127.0.0.1:5000/api/health` - 本地测试

如果仍然有问题，请提供：
1. `sudo systemctl status ppt-enhancer` 的输出
2. `sudo journalctl -u ppt-enhancer -n 50 --no-pager` 的输出
3. `curl http://127.0.0.1:5000/api/health` 的输出
