# 修复502 Bad Gateway错误

## 问题诊断

502错误通常表示Nginx无法连接到后端Gunicorn服务。

## 快速修复步骤

### 1. 检查服务状态
```bash
sudo systemctl status ppt-enhancer
```

### 2. 如果服务未运行，启动它
```bash
sudo systemctl start ppt-enhancer
```

### 3. 查看服务日志（查找错误）
```bash
sudo journalctl -u ppt-enhancer -n 100 --no-pager
```

### 4. 检查Gunicorn是否在监听5000端口
```bash
sudo netstat -tlnp | grep 5000
# 或
sudo ss -tlnp | grep 5000
```

### 5. 检查Nginx错误日志
```bash
sudo tail -n 50 /var/log/nginx/error.log
```

### 6. 如果代码有更新，重启服务
```bash
cd /srv/jp-ppt
git pull
sudo systemctl restart ppt-enhancer
```

### 7. 检查并更新systemd服务文件

确保 `/etc/systemd/system/ppt-enhancer.service` 内容正确：

```ini
[Unit]
Description=PPT Image Enhancer API
After=network.target

[Service]
User=Zhuanz
WorkingDirectory=/srv/jp-ppt
Environment="PATH=/srv/jp-ppt/venv/bin"
ExecStart=/srv/jp-ppt/venv/bin/gunicorn -w 4 -b 127.0.0.1:5000 --timeout 300 web_app:app
Restart=always

[Install]
WantedBy=multi-user.target
```

**重要**：
- `User=Zhuanz` （替换为你的实际用户名）
- `WorkingDirectory=/srv/jp-ppt` （替换为你的实际项目路径）
- `--timeout 300` （增加超时时间，因为PPT处理可能需要较长时间）
- `-b 127.0.0.1:5000` （只监听本地，由Nginx代理）

### 8. 重新加载systemd配置并重启服务
```bash
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer
sudo systemctl status ppt-enhancer
```

### 9. 检查Nginx配置

确保 `/etc/nginx/sites-available/ppt-enhancer` 配置正确：

```nginx
server {
    listen 80;
    server_name 34.168.121.40 www.rancho.website;

    client_max_body_size 100M;

    # 静态文件（如果有）
    root /srv/jp-ppt;
    index index.html;

    # API请求代理到Gunicorn
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 300s;
        proxy_connect_timeout 300s;
    }

    # 前端页面
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### 10. 测试Nginx配置并重载
```bash
sudo nginx -t
sudo systemctl reload nginx
```

## 常见问题

### 问题1：服务启动失败，提示"ModuleNotFoundError"
**解决**：确保虚拟环境中安装了所有依赖
```bash
cd /srv/jp-ppt
source venv/bin/activate
pip install -r requirements-web.txt
```

### 问题2：端口5000被占用
**解决**：检查并杀死占用端口的进程
```bash
sudo lsof -i :5000
sudo kill -9 <PID>
```

### 问题3：权限问题
**解决**：确保用户有权限访问项目目录
```bash
sudo chown -R Zhuanz:Zhuanz /srv/jp-ppt
```

### 问题4：Python路径问题
**解决**：确保systemd服务文件中的PATH正确指向虚拟环境

## 验证服务是否正常

访问健康检查接口：
```bash
curl http://127.0.0.1:5000/api/health
```

如果返回JSON响应，说明Gunicorn正常运行。

然后测试通过Nginx访问：
```bash
curl http://34.168.121.40/api/health
```

如果也返回JSON响应，说明整个链路正常。

