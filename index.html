<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æ—¥è¯­è¯æ±‡PPTå›¾ç‰‡å¢å¼ºå·¥å…· - åœ¨çº¿ç‰ˆ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
            background: white;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            overflow: hidden;
        }

        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            text-align: center;
        }

        .header h1 {
            font-size: 32px;
            margin-bottom: 10px;
        }

        .header p {
            opacity: 0.9;
            font-size: 16px;
        }

        .content {
            padding: 40px;
        }

        .upload-area {
            border: 3px dashed #667eea;
            border-radius: 15px;
            padding: 60px 20px;
            text-align: center;
            background: #f8f9ff;
            transition: all 0.3s;
            cursor: pointer;
        }

        .upload-area:hover {
            border-color: #764ba2;
            background: #f0f2ff;
        }

        .upload-area.dragover {
            border-color: #764ba2;
            background: #e8ebff;
            transform: scale(1.02);
        }

        .upload-icon {
            font-size: 64px;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            color: #667eea;
            margin-bottom: 10px;
        }

        .upload-hint {
            font-size: 14px;
            color: #999;
        }

        #fileInput {
            display: none;
        }

        .file-info {
            margin-top: 20px;
            padding: 15px;
            background: #f0f2ff;
            border-radius: 10px;
            display: none;
        }

        .file-info.show {
            display: block;
        }

        .file-name {
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }

        .file-size {
            font-size: 14px;
            color: #666;
        }

        .button {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            font-weight: bold;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 20px;
        }

        .button-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .button-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .button-primary:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .button-secondary {
            background: #f0f0f0;
            color: #666;
        }

        .button-secondary:hover {
            background: #e0e0e0;
        }

        .progress-container {
            margin-top: 30px;
            display: none;
        }

        .progress-container.show {
            display: block;
        }

        .progress-bar {
            width: 100%;
            height: 30px;
            background: #f0f0f0;
            border-radius: 15px;
            overflow: hidden;
            margin-bottom: 10px;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 14px;
        }

        .progress-text {
            text-align: center;
            color: #666;
            font-size: 14px;
            margin-bottom: 20px;
        }

        .log-container {
            max-height: 300px;
            overflow-y: auto;
            background: #1e1e1e;
            border-radius: 10px;
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 12px;
            display: none;
        }

        .log-container.show {
            display: block;
        }

        .log-line {
            color: #d4d4d4;
            margin-bottom: 5px;
            word-break: break-all;
        }

        .log-line.success {
            color: #4EC9B0;
        }

        .log-line.error {
            color: #F48771;
        }

        .log-line.warning {
            color: #DCDCAA;
        }

        .log-line.debug {
            color: #9CDCFE;
        }

        .result-container {
            margin-top: 30px;
            padding: 20px;
            background: #f0f9ff;
            border-radius: 10px;
            border: 2px solid #4EC9B0;
            display: none;
        }

        .result-container.show {
            display: block;
        }

        .result-title {
            font-size: 20px;
            font-weight: bold;
            color: #4EC9B0;
            margin-bottom: 15px;
        }

        .config-section {
            margin-top: 30px;
            padding: 20px;
            background: #f8f9ff;
            border-radius: 10px;
        }

        .config-title {
            font-size: 16px;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 10px;
        }

        .config-input {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            margin-bottom: 10px;
        }

        .config-input:focus {
            outline: none;
            border-color: #667eea;
        }

        .status-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 5px;
        }

        .status-indicator.online {
            background: #4EC9B0;
        }

        .status-indicator.offline {
            background: #F48771;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ğŸ“š æ—¥è¯­è¯æ±‡PPTå›¾ç‰‡å¢å¼ºå·¥å…·</h1>
            <p>è‡ªåŠ¨ä¸ºPPTä¸­çš„æ—¥è¯­è¯æ±‡æœç´¢ç›¸å…³å›¾ç‰‡å¹¶æ·»åŠ åˆ°é¡µé¢ä¸­</p>
            <p style="margin-top: 10px; font-size: 14px;">
                <span class="status-indicator" id="statusIndicator"></span>
                <span id="statusText">æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€...</span>
            </p>
        </div>

        <div class="content">
            <!-- é…ç½®åŒºåŸŸ -->
            <div class="config-section">
                <div class="config-title">âš™ï¸ APIæœåŠ¡å™¨åœ°å€</div>
                <input type="text" id="apiUrl" class="config-input" 
                       placeholder="https://your-server.com" 
                       value="https://www.rancho.website">
                <button class="button button-secondary" onclick="checkServer()">æ£€æŸ¥è¿æ¥</button>
            </div>

            <div class="config-section">
                <div class="config-title">ğŸ”‘ è‡ªå®šä¹‰APIé…ç½®ï¼ˆå¯é€‰ï¼Œä¼˜å…ˆä½¿ç”¨è¿™é‡Œçš„Keyï¼‰</div>
                <input type="text" id="googleAiApiKey" class="config-input" 
                       placeholder="Google AI (Gemini) API Keyï¼ˆä¼˜å…ˆä½¿ç”¨ï¼Œç”¨äºä¼˜åŒ–æœç´¢å…³é”®è¯ï¼‰">
                <input type="text" id="sparkApiKey" class="config-input" 
                       placeholder="Spark API Keyï¼ˆGeminiå¤±è´¥æ—¶ä½¿ç”¨ï¼ŒAPIPassword æˆ– AK:SKï¼‰">
                <input type="text" id="googleApiKey" class="config-input" 
                       placeholder="Google Custom Search API Keyï¼ˆç”¨äºå›¾ç‰‡æœç´¢ï¼‰">
                <input type="text" id="googleCseId" class="config-input" 
                       placeholder="Google Custom Search Engine IDï¼ˆCSE IDï¼‰">
                <small style="color:#666; line-height:1.6;">
                    è¯´æ˜ï¼š<br>
                    - å¦‚æœç•™ç©ºï¼Œåˆ™ä½¿ç”¨æœåŠ¡å™¨é»˜è®¤é…ç½®ï¼ˆç”±ç«™é•¿åœ¨æœåŠ¡å™¨ä¸Šé…ç½®ï¼‰<br>
                    - å¦‚æœå¡«å†™ï¼Œåˆ™æœ¬æ¬¡å¤„ç†ä¼šä¼˜å…ˆä½¿ç”¨ä½ è‡ªå·±çš„Keyï¼ŒKeyåªä¿å­˜åœ¨ä½ çš„æµè§ˆå™¨æœ¬åœ°ï¼Œå¹¶åªåœ¨è¯·æ±‚æ—¶å‘é€ç»™æœåŠ¡å™¨ï¼Œä¸ä¼šè¢«é¡µé¢ä»£ç è®°å½•åˆ°å…¶ä»–åœ°æ–¹ã€‚<br>
                    - AIä¼˜åŒ–å…³é”®è¯ï¼šä¼˜å…ˆä½¿ç”¨Google Geminiï¼Œå¤±è´¥åˆ™ä½¿ç”¨Spark AI<br>
                    - ä½ å¯ä»¥åœ¨ä¸åŒæµè§ˆå™¨/è®¾å¤‡ä¸Šé…ç½®ä¸åŒçš„Keyã€‚
                </small>
            </div>

            <!-- ä¸Šä¼ åŒºåŸŸ -->
            <div class="upload-area" id="uploadArea" onclick="document.getElementById('fileInput').click()">
                <div class="upload-icon">ğŸ“„</div>
                <div class="upload-text">ç‚¹å‡»æˆ–æ‹–æ‹½PPTæ–‡ä»¶åˆ°è¿™é‡Œ</div>
                <div class="upload-hint">æ”¯æŒ .pptx å’Œ .ppt æ ¼å¼ï¼Œæœ€å¤§100MB</div>
            </div>

            <input type="file" id="fileInput" accept=".pptx,.ppt" />

            <div class="file-info" id="fileInfo">
                <div class="file-name" id="fileName"></div>
                <div class="file-size" id="fileSize"></div>
            </div>

            <button class="button button-primary" id="processBtn" onclick="processFile()" disabled>
                å¼€å§‹å¤„ç†
            </button>

            <!-- è¿›åº¦åŒºåŸŸ -->
            <div class="progress-container" id="progressContainer">
                <div class="progress-text" id="progressText">å‡†å¤‡å¤„ç†...</div>
                <div class="progress-bar">
                    <div class="progress-fill" id="progressFill">0%</div>
                </div>
                <div class="log-container" id="logContainer"></div>
            </div>

            <!-- ç»“æœåŒºåŸŸ -->
            <div class="result-container" id="resultContainer">
                <div class="result-title">âœ… å¤„ç†å®Œæˆï¼</div>
                <button class="button button-primary" id="downloadBtn" onclick="downloadFile()">
                    ä¸‹è½½å¤„ç†åçš„PPT
                </button>
            </div>
        </div>
    </div>

    <script>
        let currentTaskId = null;
        let apiUrl = 'http://localhost:5000';

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            const apiUrlInput = document.getElementById('apiUrl');
            
            // ä»localStorageè¯»å–API URLï¼Œå¦‚æœæ²¡æœ‰åˆ™ä½¿ç”¨inputæ¡†çš„é»˜è®¤å€¼
            const savedUrl = localStorage.getItem('apiUrl');
            if (savedUrl) {
                apiUrlInput.value = savedUrl;
                apiUrl = savedUrl;
            } else {
                // å¦‚æœæ²¡æœ‰ä¿å­˜çš„URLï¼Œä½¿ç”¨inputæ¡†çš„é»˜è®¤å€¼ï¼ˆå¦‚æœæœ‰ï¼‰
                const defaultValue = apiUrlInput.value.trim();
                if (defaultValue) {
                    apiUrl = defaultValue;
                }
            }
            
            // è¯»å–ç”¨æˆ·çš„API Keyï¼ˆä»…å­˜å‚¨åœ¨å½“å‰æµè§ˆå™¨ï¼‰
            const savedGoogleAiKey = localStorage.getItem('googleAiApiKey');
            const savedSparkKey = localStorage.getItem('sparkApiKey');
            const savedGoogleKey = localStorage.getItem('googleApiKey');
            const savedGoogleCseId = localStorage.getItem('googleCseId');
            if (savedGoogleAiKey) document.getElementById('googleAiApiKey').value = savedGoogleAiKey;
            if (savedSparkKey) document.getElementById('sparkApiKey').value = savedSparkKey;
            if (savedGoogleKey) document.getElementById('googleApiKey').value = savedGoogleKey;
            if (savedGoogleCseId) document.getElementById('googleCseId').value = savedGoogleCseId;
            
            checkServer();
            setupFileUpload();
        });

        // è®¾ç½®æ–‡ä»¶ä¸Šä¼ 
        function setupFileUpload() {
            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');

            // ç‚¹å‡»ä¸Šä¼ 
            fileInput.addEventListener('change', function(e) {
                handleFile(e.target.files[0]);
            });

            // æ‹–æ‹½ä¸Šä¼ 
            uploadArea.addEventListener('dragover', function(e) {
                e.preventDefault();
                uploadArea.classList.add('dragover');
            });

            uploadArea.addEventListener('dragleave', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
            });

            uploadArea.addEventListener('drop', function(e) {
                e.preventDefault();
                uploadArea.classList.remove('dragover');
                handleFile(e.dataTransfer.files[0]);
            });
        }

        // å¤„ç†æ–‡ä»¶é€‰æ‹©
        function handleFile(file) {
            if (!file) return;

            if (!file.name.match(/\.(pptx|ppt)$/i)) {
                alert('è¯·é€‰æ‹©PPTæ–‡ä»¶ï¼ˆ.pptx æˆ– .pptï¼‰');
                return;
            }

            if (file.size > 100 * 1024 * 1024) {
                alert('æ–‡ä»¶å¤ªå¤§ï¼Œæœ€å¤§æ”¯æŒ100MB');
                return;
            }

            document.getElementById('fileName').textContent = file.name;
            document.getElementById('fileSize').textContent = `å¤§å°: ${(file.size / 1024 / 1024).toFixed(2)} MB`;
            document.getElementById('fileInfo').classList.add('show');
            document.getElementById('processBtn').disabled = false;
        }

        // æ£€æŸ¥æœåŠ¡å™¨çŠ¶æ€
        async function checkServer() {
            const urlInput = document.getElementById('apiUrl');
            const url = urlInput.value.trim();
            
            // å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œä½¿ç”¨inputæ¡†çš„é»˜è®¤å€¼
            const finalUrl = url || urlInput.getAttribute('value') || 'https://www.rancho.website';
            
            if (!finalUrl) {
                updateStatus(false, 'è¯·è¾“å…¥APIæœåŠ¡å™¨åœ°å€');
                return;
            }

            // æ›´æ–°inputæ¡†çš„å€¼ï¼ˆå¦‚æœä¹‹å‰æ˜¯ç©ºçš„ï¼‰
            if (!url && finalUrl) {
                urlInput.value = finalUrl;
            }
            
            apiUrl = finalUrl;
            localStorage.setItem('apiUrl', finalUrl);

            try {
                const response = await fetch(`${apiUrl}/api/health`);
                const data = await response.json();
                
                if (data.status === 'ok') {
                    // æ„å»ºè¯¦ç»†çš„çŠ¶æ€ä¿¡æ¯
                    const statusDetails = [];
                    statusDetails.push(`âœ“ æœåŠ¡å™¨è¿æ¥æ­£å¸¸`);
                    statusDetails.push(`Google Custom Search: ${data.server_google_api_configured ? 'âœ“ å·²é…ç½®' : 'âœ— æœªé…ç½®'}`);
                    statusDetails.push(`Google AI (Gemini): ${data.server_google_ai_configured ? 'âœ“ å·²é…ç½®' : 'âœ— æœªé…ç½®'}`);
                    statusDetails.push(`Spark AI: ${data.server_spark_api_configured ? 'âœ“ å·²é…ç½®' : 'âœ— æœªé…ç½®'}`);
                    
                    const msg = statusDetails.join('\n');
                    alert(msg + '\n\næç¤ºï¼šå¦‚æœæœåŠ¡å™¨æœªé…ç½®API Keyï¼Œå¯åœ¨ä¸‹æ–¹å¡«å†™ä½ è‡ªå·±çš„Key');
                    updateStatus(true, 'æœåŠ¡å™¨è¿æ¥æ­£å¸¸');
                } else {
                    updateStatus(false, 'æœåŠ¡å™¨å“åº”å¼‚å¸¸');
                    alert('æœåŠ¡å™¨å“åº”å¼‚å¸¸: ' + (data.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                updateStatus(false, 'æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨');
                alert('æ— æ³•è¿æ¥åˆ°æœåŠ¡å™¨: ' + error.message);
            }
        }

        // æ›´æ–°çŠ¶æ€æŒ‡ç¤ºå™¨
        function updateStatus(online, text) {
            const indicator = document.getElementById('statusIndicator');
            const statusText = document.getElementById('statusText');
            
            indicator.className = 'status-indicator ' + (online ? 'online' : 'offline');
            statusText.textContent = text;
        }

        // å¤„ç†æ–‡ä»¶
        async function processFile() {
            // ç¡®ä¿apiUrlå·²è®¾ç½®ï¼ˆä½¿ç”¨inputæ¡†çš„å€¼æˆ–é»˜è®¤å€¼ï¼‰
            const urlInput = document.getElementById('apiUrl');
            const url = urlInput.value.trim();
            if (url) {
                apiUrl = url;
                localStorage.setItem('apiUrl', url);
            } else {
                // å¦‚æœæ²¡æœ‰è¾“å…¥ï¼Œä½¿ç”¨inputæ¡†çš„é»˜è®¤å€¼
                const defaultValue = urlInput.getAttribute('value') || 'https://www.rancho.website';
                if (defaultValue) {
                    apiUrl = defaultValue;
                    urlInput.value = defaultValue;
                    localStorage.setItem('apiUrl', defaultValue);
                } else {
                    alert('è¯·å…ˆè¾“å…¥APIæœåŠ¡å™¨åœ°å€');
                    return;
                }
            }
            
            const fileInput = document.getElementById('fileInput');
            const file = fileInput.files[0];
            
            if (!file) {
                alert('è¯·å…ˆé€‰æ‹©æ–‡ä»¶');
                return;
            }

            // é‡ç½®UI
            document.getElementById('processBtn').disabled = true;
            document.getElementById('progressContainer').classList.add('show');
            document.getElementById('resultContainer').classList.remove('show');
            document.getElementById('logContainer').innerHTML = '';
            document.getElementById('progressFill').style.width = '0%';
            document.getElementById('progressFill').textContent = '0%';

            const formData = new FormData();
            formData.append('file', file);

            // è¯»å–ç”¨æˆ·APIé…ç½®ï¼ˆå¦‚æœå¡«å†™åˆ™ä¸€å¹¶å‘é€ç»™åç«¯ï¼Œä»…åœ¨æœ¬æ¬¡è¯·æ±‚ä¸­ä½¿ç”¨ï¼‰
            const googleAiKey = document.getElementById('googleAiApiKey').value.trim();
            const sparkKey = document.getElementById('sparkApiKey').value.trim();
            const googleKey = document.getElementById('googleApiKey').value.trim();
            const googleCseId = document.getElementById('googleCseId').value.trim();

            if (googleAiKey) {
                formData.append('google_ai_api_key', googleAiKey);
                localStorage.setItem('googleAiApiKey', googleAiKey);
            }
            if (sparkKey) {
                formData.append('spark_api_key', sparkKey);
                localStorage.setItem('sparkApiKey', sparkKey);
            }
            if (googleKey) {
                formData.append('google_api_key', googleKey);
                localStorage.setItem('googleApiKey', googleKey);
            }
            if (googleCseId) {
                formData.append('google_cse_id', googleCseId);
                localStorage.setItem('googleCseId', googleCseId);
            }

            try {
                addLog('æ­£åœ¨ä¸Šä¼ æ–‡ä»¶...', 'info');
                document.getElementById('progressFill').style.width = '5%';
                document.getElementById('progressFill').textContent = '5%';

                const response = await fetch(`${apiUrl}/api/process`, {
                    method: 'POST',
                    body: formData
                });

                const data = await response.json();
                
                if (data.status === 'success') {
                    currentTaskId = data.task_id;
                    
                    // å¼€å§‹è½®è¯¢è¿›åº¦
                    const pollProgress = async () => {
                        try {
                            const progressResponse = await fetch(`${apiUrl}/api/progress/${currentTaskId}`);
                            const progressData = await progressResponse.json();
                            
                            // æ›´æ–°è¿›åº¦æ¡
                            if (progressData.progress !== undefined) {
                                document.getElementById('progressFill').style.width = progressData.progress + '%';
                                document.getElementById('progressFill').textContent = progressData.progress + '%';
                                
                                // æ›´æ–°è¿›åº¦æ–‡æœ¬
                                if (progressData.current_page && progressData.total_pages) {
                                    document.getElementById('progressText').textContent = 
                                        `å¤„ç†ä¸­... ${progressData.current_page}/${progressData.total_pages} é¡µ (${progressData.progress}%)`;
                                }
                            }
                            
                            // æ›´æ–°æ—¥å¿—
                            if (progressData.logs && progressData.logs.length > 0) {
                                document.getElementById('logContainer').classList.add('show');
                                const logContainer = document.getElementById('logContainer');
                                const currentLogCount = logContainer.children.length;
                                
                                // åªæ·»åŠ æ–°æ—¥å¿—
                                progressData.logs.slice(currentLogCount).forEach(log => {
                                    addLog(log, 'info');
                                });
                            }
                            
                            // å¦‚æœè¿˜åœ¨å¤„ç†ä¸­ï¼Œç»§ç»­è½®è¯¢
                            if (progressData.status === 'processing') {
                                setTimeout(pollProgress, 1000); // æ¯ç§’è½®è¯¢ä¸€æ¬¡
                            } else if (progressData.status === 'success') {
                                // å¤„ç†å®Œæˆ
                                addLog('å¤„ç†å®Œæˆï¼', 'success');
                                document.getElementById('progressFill').style.width = '100%';
                                document.getElementById('progressFill').textContent = '100%';
                                document.getElementById('progressText').textContent = 'å¤„ç†å®Œæˆï¼';
                                
                                // æ˜¾ç¤ºæ‰€æœ‰æ—¥å¿—
                                if (progressData.logs && progressData.logs.length > 0) {
                                    document.getElementById('logContainer').classList.add('show');
                                }
                                
                                // æ˜¾ç¤ºç»“æœ
                                document.getElementById('resultContainer').classList.add('show');
                            } else if (progressData.status === 'error') {
                                throw new Error(progressData.error || 'å¤„ç†å¤±è´¥');
                            }
                        } catch (error) {
                            console.error('è½®è¯¢è¿›åº¦å¤±è´¥:', error);
                            // å³ä½¿è½®è¯¢å¤±è´¥ï¼Œä¹Ÿå°è¯•ç­‰å¾…æœ€ç»ˆç»“æœ
                            setTimeout(pollProgress, 2000);
                        }
                    };
                    
                    // å¼€å§‹è½®è¯¢
                    pollProgress();
                } else {
                    throw new Error(data.error || 'å¤„ç†å¤±è´¥');
                }
            } catch (error) {
                addLog(`é”™è¯¯: ${error.message}`, 'error');
                alert(`å¤„ç†å¤±è´¥: ${error.message}`);
            } finally {
                document.getElementById('processBtn').disabled = false;
            }
        }

        // ä¸‹è½½æ–‡ä»¶
        function downloadFile() {
            if (!currentTaskId) {
                alert('æ²¡æœ‰å¯ä¸‹è½½çš„æ–‡ä»¶');
                return;
            }

            window.location.href = `${apiUrl}/api/download/${currentTaskId}`;
        }

        // æ·»åŠ æ—¥å¿—
        function addLog(message, type = 'info') {
            const logContainer = document.getElementById('logContainer');
            const logLine = document.createElement('div');
            logLine.className = `log-line ${type}`;
            logLine.textContent = message;
            logContainer.appendChild(logLine);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
    </script>
</body>
</html>

