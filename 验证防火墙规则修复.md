# 验证防火墙规则修复

## 已完成
✅ DNS解析正常（指向 34.142.75.113）
✅ GCP防火墙规则已创建（allow-http 和 allow-https）

## 现在测试

### 1. 测试HTTP访问

```bash
# 测试IP地址
curl -I http://34.142.75.113/
curl http://34.142.75.113/api/health

# 测试域名
curl -I http://www.rancho.website/
curl http://www.rancho.website/api/health
```

### 2. 测试HTTPS访问（如果已配置SSL）

```bash
# 测试IP地址
curl -I https://34.142.75.113/ -k
curl https://34.142.75.113/api/health -k

# 测试域名
curl -I https://www.rancho.website/
curl https://www.rancho.website/api/health
```

### 3. 在浏览器中测试

访问：
- `http://www.rancho.website/`
- `http://www.rancho.website/api/health`
- `https://www.rancho.website/`（如果已配置SSL）

## 如果仍然超时

### 检查1：防火墙规则是否生效

```bash
# 查看防火墙规则
gcloud compute firewall-rules list | grep -E 'allow-http|allow-https'

# 查看规则详情
gcloud compute firewall-rules describe allow-http
gcloud compute firewall-rules describe allow-https
```

### 检查2：实例的网络标签

```bash
# 查看实例详情
gcloud compute instances describe instance-20251228-095410 \
    --zone europe-west2-a \
    --format="get(tags.items)"

# 如果规则使用了标签，确保实例有相应标签
```

### 检查3：等待规则生效

防火墙规则创建后，可能需要几秒钟才能生效。等待10-20秒后重试。

### 检查4：检查实例的网络配置

```bash
# 查看实例的网络接口
gcloud compute instances describe instance-20251228-095410 \
    --zone europe-west2-a \
    --format="get(networkInterfaces[0].network)"
```

## 如果仍然无法访问

### 方案1：检查是否有其他防火墙规则阻止

```bash
# 列出所有防火墙规则
gcloud compute firewall-rules list

# 查找是否有deny规则
gcloud compute firewall-rules list --filter="direction=INGRESS AND denied"
```

### 方案2：检查VPC网络配置

确保实例在正确的VPC网络中，并且防火墙规则应用到该网络。

### 方案3：检查实例是否在运行

```bash
# 在服务器上检查
sudo systemctl status nginx
sudo systemctl status ppt-enhancer
sudo netstat -tlnp | grep -E ':(80|443|5000)'
```

## 验证成功

如果测试通过，应该看到：

```bash
$ curl http://34.142.75.113/api/health
{"status":"ok","message":"PPT图片增强服务运行正常",...}

$ curl http://www.rancho.website/api/health
{"status":"ok","message":"PPT图片增强服务运行正常",...}
```

## 配置HTTPS（如果还没有）

如果HTTP可以访问但HTTPS不行，需要配置SSL证书：

```bash
# 在服务器上运行
sudo certbot --nginx -d www.rancho.website
```

## 完成！

如果所有测试通过，网站应该可以正常访问了！




