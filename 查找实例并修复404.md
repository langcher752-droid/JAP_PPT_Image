# 查找实例并修复404错误

## 问题
1. 实例名称找不到
2. 后端服务正常，但通过Nginx访问返回404

## 步骤1：查找正确的实例名称

```bash
# 列出所有实例
gcloud compute instances list

# 查找包含特定名称的实例
gcloud compute instances list --filter="name~instance"

# 查看所有实例的详细信息
gcloud compute instances list --format="table(name,zone,status,EXTERNAL_IP)"
```

## 步骤2：修复404错误（先解决这个）

后端服务正常，说明问题在Nginx配置。

### 检查Nginx配置

在服务器上运行：

```bash
# 1. 检查后端服务
curl http://127.0.0.1:5000/api/health
# 应该返回JSON

# 2. 检查Nginx配置中的location /api/块
sudo grep -A 10 "location /api/" /etc/nginx/sites-available/ppt-enhancer

# 3. 测试本地Nginx代理
curl http://127.0.0.1/api/health

# 4. 查看完整Nginx配置
sudo cat /etc/nginx/sites-available/ppt-enhancer
```

### 如果缺少location /api/配置

编辑Nginx配置：

```bash
sudo nano /etc/nginx/sites-available/ppt-enhancer
```

**确保包含以下配置：**

```nginx
server {
    listen 80;
    server_name rancho.website www.rancho.website 136.118.201.245 34.142.75.113 _;
    
    client_max_body_size 100M;
    
    # 增加超时时间
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    send_timeout 600s;
    
    # API请求代理到后端（重要！）
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
    
    # 静态文件
    root /srv/jp-ppt;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

### 应用配置

```bash
# 测试配置
sudo nginx -t

# 重载Nginx
sudo systemctl reload nginx

# 测试
curl http://127.0.0.1/api/health
curl http://136.118.201.245/api/health
```

## 步骤3：配置静态IP（找到正确实例名称后）

### 查找实例

```bash
# 列出所有实例
gcloud compute instances list

# 查看实例的外部IP
gcloud compute instances list --format="table(name,zone,status,EXTERNAL_IP)"
```

### 分配静态IP

找到正确的实例名称后（假设是 `instance-20251228-095410`）：

```bash
# 查看实例的当前外部IP配置
gcloud compute instances describe [实例名称] \
    --zone [区域] \
    --format="get(networkInterfaces[0].accessConfigs[0].name,networkInterfaces[0].accessConfigs[0].natIP)"

# 删除临时外部IP配置
gcloud compute instances delete-access-config [实例名称] \
    --zone [区域] \
    --access-config-name "External NAT"

# 添加静态IP
gcloud compute instances add-access-config [实例名称] \
    --zone [区域] \
    --access-config-name "External NAT" \
    --address 34.142.75.113
```

## 快速诊断脚本

在服务器上运行：

```bash
echo "=== 1. 后端服务测试 ==="
curl -s http://127.0.0.1:5000/api/health
echo ""
echo ""

echo "=== 2. Nginx配置检查 ==="
sudo grep -E "location /api/|proxy_pass" /etc/nginx/sites-available/ppt-enhancer
echo ""

echo "=== 3. 测试本地Nginx代理 ==="
curl -s http://127.0.0.1/api/health
echo ""
echo ""

echo "=== 4. Nginx错误日志 ==="
sudo tail -5 /var/log/nginx/error.log
echo ""

echo "=== 5. Nginx访问日志 ==="
sudo tail -5 /var/log/nginx/access.log
```

## 如果location /api/配置缺失

快速添加配置：

```bash
# 备份配置
sudo cp /etc/nginx/sites-available/ppt-enhancer /etc/nginx/sites-available/ppt-enhancer.backup

# 检查配置中是否有location /api/
if ! sudo grep -q "location /api/" /etc/nginx/sites-available/ppt-enhancer; then
    echo "缺少location /api/配置，需要手动添加"
    echo "请运行: sudo nano /etc/nginx/sites-available/ppt-enhancer"
    echo "在server块中添加location /api/配置"
else
    echo "location /api/配置已存在"
    sudo grep -A 5 "location /api/" /etc/nginx/sites-available/ppt-enhancer
fi
```

## 完整的Nginx配置示例

如果配置缺失，使用以下完整配置：

```bash
sudo nano /etc/nginx/sites-available/ppt-enhancer
```

**完整配置：**

```nginx
server {
    listen 80;
    server_name rancho.website www.rancho.website 136.118.201.245 34.142.75.113 _;
    
    client_max_body_size 100M;
    
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    send_timeout 600s;
    
    # API请求代理到后端
    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
    
    # 静态文件
    root /srv/jp-ppt;
    index index.html;
    
    location / {
        try_files $uri $uri/ /index.html;
    }
}
```

## 验证修复

修复后，应该看到：

```bash
$ curl http://127.0.0.1/api/health
{"status":"ok","message":"PPT图片增强服务运行正常",...}

$ curl http://136.118.201.245/api/health
{"status":"ok","message":"PPT图片增强服务运行正常",...}
```

而不是404错误。




