# 优化现有服务器配置

## 问题
1. 内存不足导致 Worker 被 SIGKILL
2. 504 Gateway Timeout 超时错误
3. API 配额用完导致重试过多

## 解决方案

### 1. 优化 Gunicorn 配置（利用更多内存提升性能）

编辑 systemd 服务文件：
```bash
sudo nano /etc/systemd/system/ppt-enhancer.service
```

**修改 ExecStart 行：**
```ini
# 对于16G内存的服务器，可以使用更多worker提升性能
# 推荐配置：4个worker（每个worker约占用200-300MB内存）
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 4 --timeout 600 --max-requests 1000 --max-requests-jitter 50 --worker-class sync web_app:app

# 如果内存充足，也可以使用更多worker（最多8个）
# ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 8 --timeout 600 --max-requests 1000 --max-requests-jitter 50 --worker-class sync web_app:app
```

**Worker数量建议：**
- 1-2个worker：适合1-2GB内存
- 4个worker：适合4-8GB内存（推荐，平衡性能和稳定性）
- 6-8个worker：适合8-16GB内存（高并发场景）
- 超过8个：通常不推荐，可能增加上下文切换开销

**完整服务文件示例：**
```ini
[Unit]
Description=PPT Image Enhancer API
After=network.target

[Service]
User=你的用户名
Group=你的用户组
WorkingDirectory=/srv/jp-ppt
Environment="PATH=/srv/jp-ppt/venv/bin"
Environment="PYTHONPATH=/srv/jp-ppt"
Environment="GOOGLE_API_KEY=你的密钥"
Environment="GOOGLE_CSE_ID=你的CSE ID"
Environment="GOOGLE_AI_API_KEY=你的密钥"
Environment="SPARK_API_KEY=你的密钥"
Environment="SPARK_BASE_URL=https://spark-api-open.xf-yun.com/v2"
Environment="SPARK_MODEL=spark-x"

# 关键优化：4个worker提升性能，600秒超时，自动重启worker防止内存泄漏
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 4 --timeout 600 --max-requests 1000 --max-requests-jitter 50 web_app:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
```

**应用更改：**
```bash
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer
sudo systemctl status ppt-enhancer
```

### 2. 优化 Nginx 超时配置

编辑 Nginx 配置：
```bash
sudo nano /etc/nginx/sites-available/ppt-enhancer
```

**确保包含以下超时配置：**
```nginx
server {
    listen 80;
    listen [::]:80;
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name www.rancho.website rancho.website;

    # 增加超时时间（重要！）
    proxy_connect_timeout 600s;
    proxy_send_timeout 600s;
    proxy_read_timeout 600s;
    send_timeout 600s;
    client_max_body_size 100M;

    # SSL配置（如果有）
    # ssl_certificate /etc/letsencrypt/live/www.rancho.website/fullchain.pem;
    # ssl_certificate_key /etc/letsencrypt/live/www.rancho.website/privkey.pem;

    location / {
        root /srv/jp-ppt;
        try_files $uri $uri/ /index.html;
        index index.html;
    }

    location /api/ {
        proxy_pass http://127.0.0.1:5000;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        
        # 增加API请求的超时时间
        proxy_connect_timeout 600s;
        proxy_send_timeout 600s;
        proxy_read_timeout 600s;
    }
}
```

**应用配置：**
```bash
sudo nginx -t
sudo systemctl reload nginx
```

### 3. 更新代码（减少重试次数）

```bash
cd /srv/jp-ppt

# 如果使用git
git pull

# 或者手动上传更新后的 main.py

# 验证代码更新
source venv/bin/activate
python -c "from web_app import app; print('Import OK')"

# 重启服务
sudo systemctl restart ppt-enhancer
```

### 4. 检查内存使用

```bash
# 查看内存使用情况
free -h

# 查看进程内存使用
ps aux --sort=-%mem | head -10

# 查看服务内存使用
sudo systemctl status ppt-enhancer
```

### 5. 添加内存监控（可选）

如果内存仍然不足，可以添加内存限制和监控：

```bash
# 编辑服务文件，添加内存限制
sudo nano /etc/systemd/system/ppt-enhancer.service
```

在 `[Service]` 部分添加：
```ini
[Service]
...
# 限制内存使用（如果超过512MB，自动重启）
MemoryLimit=512M
MemoryHigh=400M
```

**应用更改：**
```bash
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer
```

### 6. 清理临时文件（释放空间）

```bash
cd /srv/jp-ppt

# 清理旧的临时文件
find temp_images -type f -mtime +1 -delete
find uploads -type f -mtime +1 -delete
find outputs -type f -mtime +1 -delete

# 查看磁盘使用
df -h
```

### 7. 添加自动清理定时任务（可选）

```bash
# 编辑crontab
crontab -e

# 添加每天凌晨2点清理临时文件
0 2 * * * find /srv/jp-ppt/temp_images -type f -mtime +1 -delete
0 2 * * * find /srv/jp-ppt/uploads -type f -mtime +1 -delete
0 2 * * * find /srv/jp-ppt/outputs -type f -mtime +1 -delete
```

## 快速优化脚本

一键执行所有优化：

```bash
#!/bin/bash
# 优化现有服务器配置

echo "1. 更新代码..."
cd /srv/jp-ppt
git pull || echo "Git pull失败，请手动更新代码"

echo "2. 优化systemd服务配置..."
sudo tee /etc/systemd/system/ppt-enhancer.service > /dev/null <<EOF
[Unit]
Description=PPT Image Enhancer API
After=network.target

[Service]
User=$(whoami)
Group=$(id -gn)
WorkingDirectory=/srv/jp-ppt
Environment="PATH=/srv/jp-ppt/venv/bin"
Environment="PYTHONPATH=/srv/jp-ppt"
ExecStart=/srv/jp-ppt/venv/bin/gunicorn --bind 127.0.0.1:5000 --workers 4 --timeout 600 --max-requests 1000 --max-requests-jitter 50 web_app:app
Restart=always
RestartSec=10

[Install]
WantedBy=multi-user.target
EOF

echo "3. 重新加载systemd..."
sudo systemctl daemon-reload
sudo systemctl restart ppt-enhancer

echo "4. 检查服务状态..."
sudo systemctl status ppt-enhancer --no-pager -l | head -20

echo "5. 测试API..."
sleep 2
curl -s http://127.0.0.1:5000/api/health | head -5

echo ""
echo "优化完成！"
echo "请手动检查："
echo "1. Nginx超时配置（sudo nano /etc/nginx/sites-available/ppt-enhancer）"
echo "2. API密钥配置（在systemd服务文件中）"
```

保存为 `optimize.sh`，然后运行：
```bash
chmod +x optimize.sh
./optimize.sh
```

## 验证优化效果

```bash
# 1. 检查服务状态
sudo systemctl status ppt-enhancer

# 2. 查看内存使用
free -h

# 3. 测试API
curl http://127.0.0.1:5000/api/health

# 4. 查看日志（确认没有内存错误）
sudo journalctl -u ppt-enhancer -n 50 --no-pager | grep -i "memory\|kill\|error"
```

## 关键优化点总结

1. ✅ **增加Worker数量**：使用4个worker（16G内存），提升并发处理能力
2. ✅ **增加超时时间**：从300秒改为600秒，避免504错误
3. ✅ **添加请求限制**：`--max-requests 1000` 自动重启worker，防止内存泄漏
4. ✅ **减少重试次数**：代码已优化，最多重试3次
5. ✅ **Nginx超时配置**：确保所有超时时间都是600秒

## Worker数量选择指南

根据服务器内存选择合适的worker数量：

| 内存大小 | 推荐Worker数 | 说明 |
|---------|-------------|------|
| 1-2GB   | 1-2个       | 最小配置 |
| 4-8GB   | 4个         | 推荐配置，平衡性能和稳定性 |
| 8-16GB  | 6-8个       | 高并发场景 |
| 16GB+   | 8-12个      | 极高并发，需要监控性能 |

**计算公式：** `worker数量 = (CPU核心数 × 2) + 1`，但不超过内存限制

**内存估算：** 每个worker约占用200-300MB内存（处理PPT时可能更多）

优化后，服务应该更稳定，不再出现内存不足和超时问题。

